#include <errno.h>
#include <sys/stat.h>
#include <sys/types.h>

#include "../measure/profile.h"
#include "../common/nodekey_mapping.h"
#include "../common/ancillary.h"
#include "../common/config.h"
#include "../common/packet.h"

extern conf_t* conf;
extern struct PacketStat packet_stat;

int main (int argc, char *argv []) {

	if (argc != 3) {
		LOG_ERR("Usage: %s [config file] [time index >= 0]\n", argv[0]);
	}

	// get config information
	conf = Config_Init(argv[1]);
	const char* dir = conf_common_data_dir(conf); // data/caida2018/
	const char* save_dir = conf_common_save_dir(conf); // data/caida2018/2500ms/
	if (access(save_dir, 0) == -1) {
		LOG_MSG("Create dir %s\n", save_dir);
		mkdir(save_dir, S_IRUSR | S_IWUSR | S_IXUSR);
		// mkdir(save_dir, S_IRUSR | S_IWUSR | S_IXUSR | S_IRGRP | S_IWGRP | S_IROTH | S_IWOTH);
	}

	// open packet stat file
	const char* packet_stat_file = conf_common_packet_stat_file(conf);
	const char* packet_stat_path = path_join(dir, packet_stat_file);
	FILE* stat_fd = fopen(packet_stat_path, "rb");
	if (stat_fd == NULL) {
		LOG_ERR("cannot open %s: %s\n", packet_stat_path, strerror(errno));
	}

	// read packet stat
	int stat_cnt = fread(&packet_stat, sizeof(PacketStat), 1, stat_fd);
	if (stat_cnt != 1) {
		LOG_ERR("Invalid read element count %d of packet stat which should be %d: %s\n",
				stat_cnt, 1, strerror(errno));
	}
	fclose(stat_fd);

	// open record file which is generated by trace_process module
	const char* record_file = conf_common_record_file(conf);
	const char* record_path = path_join(dir, record_file);
	FILE* record_fd = fopen(record_path, "rb");
	if (record_fd == NULL) {
		LOG_ERR("cannot open %s: %s\n", record_path, strerror(errno));
	}

	uint64_t start_ts = now_us();

	// read tuples and udpate statistics
	uint32_t time_index = atoi(argv[2]);
	char output_filename[100];
	sprintf(output_filename, "%s/split_%d.bin", save_dir, time_index);
	FILE* split_fd = fopen(output_filename, "wb");
	if (split_fd == NULL) {
		LOG_ERR("cannot open %s: %s\n", output_filename, strerror(errno));
	}

	tuple_t t;
	double time_interval = TIME_INTERVAL;
	while (1) {
		int read_cnt = fread(&t, sizeof(tuple_t), 1, record_fd);
		if (read_cnt != 1) {
			if (ferror(record_fd)) {
				LOG_ERR("read record file error: %s\n",strerror(errno));
			}
			else if (feof(record_fd)) {
				LOG_MSG("read record file end\n");
				break;
			}
			else {
				LOG_ERR("read record file error: unknown error\n");
			}
		}

		uint32_t cur_index = uint32_t((t.pkt_ts - packet_stat.trace_start_ts) / time_interval);
		if (cur_index == time_index) {
			fwrite(&t, sizeof(tuple_t), 1, split_fd);
		}
	}
	fclose(record_fd);
	fclose(split_fd);

	uint64_t end_ts = now_us();
	LOG_MSG("time cost: %ld us\n", end_ts - start_ts);
}
